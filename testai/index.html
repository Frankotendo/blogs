
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NexRyde | Next-Gen Logistics</title>
    
    <!-- PWA & Mobile Optimization -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="/NexRyde.png">
     <link rel="icon" href="/NexRyde192.png">
     <link rel="icon" href="/NexRyde152.png">
    <meta name="theme-color" content="#f59e0b">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/shapes/svg?seed=nexryde&backgroundColor=f59e0b">

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7812709042449387" crossorigin="anonymous"></script>
    <!-- AMP Auto Ads (for AMP pages; non-AMP sites use the script above) -->
    <script async custom-element="amp-auto-ads" src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- UniHub Live Tracking Module - Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin="" />
    
    <!-- UniHub Live Tracking Module - Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <!-- UniHub Live Tracking Module - Socket.IO JS -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #f8fafc;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .glass-bright {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #020617;
        }
        ::-webkit-scrollbar-thumb {
            background: #1e293b;
            border-radius: 10px;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Scanner UI Tweaks */
        #qr-reader {
          border: none !important;
          border-radius: 2rem;
          overflow: hidden;
        }
        #qr-reader__scan_region {
          background: #020617 !important;
        }
        #qr-reader__dashboard {
          padding: 20px !important;
        }
        #qr-reader__dashboard_section_csr button {
          background-color: #4f46e5 !important;
          color: white !important;
          border-radius: 0.75rem !important;
          padding: 8px 16px !important;
          font-weight: 800 !important;
          text-transform: uppercase !important;
          font-size: 10px !important;
        }

        @keyframes scan {
          0% { top: 0; }
          100% { top: 100%; }
        }
        .scanner-line {
          height: 2px;
          background: #10b981;
          position: absolute;
          width: 100%;
          animation: scan 2s linear infinite;
          box-shadow: 0 0 15px #10b981;
          z-index: 20;
          left: 0;
        }
        
        /* UniHub Live Tracking Module - Map Styles */
        #map {
          height: 400px;
          width: 100%;
          border: 1px solid #334155;
          border-radius: 8px;
          margin: 20px 0;
          background: #0f172a;
          position: relative;
          z-index: 100;
          display: block;
        }
        
        @media (max-width: 768px) {
          #map {
            height: 300px;
            margin: 10px 0;
          }
        }
        
        /* Ensure map is not hidden behind React app */
        #root {
          position: relative;
          z-index: 1;
        }
        
        body {
          position: relative;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "@google/genai": "https://esm.sh/@google/genai@^1.38.0",
    "react/": "https://esm.sh/react@^19.2.4/",
    "vite": "https://esm.sh/vite@^7.3.1",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2",
    "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@^2.93.3"
  }
}
</script>
<!-- Inline styles only; no index.css to avoid 404/MIME issues when missing -->
</head>
<body>
    <div id="root"></div>
    
    <!-- UniHub Live Tracking Module - Map Container -->
    <div id="map"></div>
    
    <!-- Enhanced Location Tracking -->
    <script src="enhanced-location-tracker.js"></script>
    
    <!-- Driver Navigation System -->
    <script src="driver-navigation-system.js"></script>
    
    <!-- Role-based Tracking -->
    <script src="role-based-tracking.js"></script>
    
    <!-- NexRyde Demand Analysis -->
    <script src="nexryde-demand-analysis.js"></script>
    
    <!-- Map Layout & Location Fixes -->
    <script src="map-layout-location-fix.js"></script>
    
    <!-- Role Selector for Testing -->
    <div id="role-selector" style="position: fixed; top: 20px; left: 20px; z-index: 10000; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <div style="font-size: 12px; margin-bottom: 5px;">üë§ User Role:</div>
        <select onchange="window.UniHubTracking.setUserRole(this.value)" style="padding: 5px; border-radius: 4px; border: 1px solid #d1d5db;">
            <option value="PASSENGER">üìç Passenger</option>
            <option value="DRIVER">üöó Driver</option>
            <option value="ADMIN">‚öôÔ∏è Admin</option>
        </select>
    </div>
    
    <script type="module" src="./index.tsx"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => {
                    console.warn('SW registration failed:', err);
                });
            });
        }
    </script>
    
    <!-- UniHub Live Tracking Module - Inline Script (fixes MIME issues) -->
    <script>
        // Enhanced tracking module - inline to avoid MIME issues
        (function() {
            'use strict';
            
            // Global variables
            let map = null;
            let drivers = {};
            let passengerMarker = null;
            let passengerPosition = null;
            let simulationInterval = null;
            let watchId = null;
            let locationPermission = null;
            let currentVehicleFilter = 'all';
            let isMobile = window.innerWidth <= 768;
            let mapVisible = !isMobile;
            let activeMission = null;
            let activeRoute = null;
            let driverRoute = null;
            let passengerRoute = null;
            let routeControl = null;
            let geocodedLocations = new Map(); // Cache for geocoded locations
            
            // Configuration
            const config = {
                mapCenter: [5.6037, -0.18696], // Kumasi, Ghana
                defaultZoom: 13,
                maxZoom: 19,
                updateInterval: 2000,
                geolocationOptions: {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                },
                routing: {
                    profile: 'driving', // driving, walking, cycling
                    alternatives: false,
                    steps: true,
                    annotations: true,
                    overview: 'full'
                },
                vehicleTypes: {
                    taxi: { 
                        name: 'Taxi', 
                        icon: 'üöï', 
                        color: '#fbbf24',
                        baseFare: 5.00, 
                        capacity: 4,
                        waitTime: '5-10 min'
                    },
                    shuttle: { 
                        name: 'Shuttle', 
                        icon: 'üöå', 
                        color: '#3b82f6',
                        baseFare: 3.00, 
                        capacity: 12,
                        waitTime: '10-15 min'
                    },
                    pragia: { 
                        name: 'Pragia', 
                        icon: 'üèçÔ∏è', 
                        color: '#10b981',
                        baseFare: 2.00, 
                        capacity: 2,
                        waitTime: '3-5 min'
                    }
                }
            };
            
            // Initialize tracking system
            function initTracking() {
                console.log('üöÄ Initializing UniHub Enhanced Tracking...');
                
                // Detect mobile
                isMobile = window.innerWidth <= 768;
                mapVisible = !isMobile;
                
                // Create UI elements
                createUI();
                
                // Wait for Leaflet to be available with timeout
                let leafletAttempts = 0;
                const maxAttempts = 20;
                
                function tryInitMap() {
                    leafletAttempts++;
                    console.log(`üó∫Ô∏è Checking for Leaflet... Attempt ${leafletAttempts}/${maxAttempts}`);
                    
                    if (typeof L !== 'undefined') {
                        console.log('‚úÖ Leaflet loaded, initializing map...');
                        initMap();
                        requestLocationPermission();
                        startDriverSimulation();
                        console.log('‚úÖ Enhanced Tracking initialized');
                    } else if (leafletAttempts < maxAttempts) {
                        console.log('‚è≥ Leaflet not yet loaded, waiting...');
                        setTimeout(tryInitMap, 500);
                    } else {
                        console.error('‚ùå Leaflet failed to load after maximum attempts');
                        showNotification('‚ùå Map loading failed - Please refresh the page');
                        loadLeafletManually();
                    }
                }
                
                tryInitMap();
            }
            
            // Load Leaflet manually if CDN fails
            function loadLeafletManually() {
                console.log('üîß Attempting to load Leaflet manually...');
                
                // Create Leaflet CSS
                const leafletCSS = document.createElement('link');
                leafletCSS.rel = 'stylesheet';
                leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                document.head.appendChild(leafletCSS);
                
                // Create Leaflet JS
                const leafletJS = document.createElement('script');
                leafletJS.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                leafletJS.onload = () => {
                    console.log('‚úÖ Leaflet loaded manually');
                    setTimeout(() => {
                        initMap();
                        requestLocationPermission();
                        startDriverSimulation();
                    }, 1000);
                };
                leafletJS.onerror = () => {
                    console.error('‚ùå Manual Leaflet loading failed');
                    showNotification('‚ùå Unable to load map - Check internet connection');
                };
                document.head.appendChild(leafletJS);
            }
            
            // Create UI elements
            function createUI() {
                // Create mobile toggle button
                const mobileToggle = document.createElement('button');
                mobileToggle.id = 'mobile-map-toggle';
                mobileToggle.innerHTML = 'üó∫Ô∏è Show Map';
                mobileToggle.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    background: #3b82f6;
                    color: white;
                    border: none;
                    padding: 12px 20px;
                    border-radius: 25px;
                    font-size: 14px;
                    font-weight: 600;
                    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                    z-index: 10001;
                    cursor: pointer;
                    transition: all 0.3s ease;
                `;
                mobileToggle.onclick = () => {
                    console.log('üó∫Ô∏è Toggle clicked');
                    toggleMobileMap();
                };
                document.body.appendChild(mobileToggle);
                
                // Create vehicle type filter
                const vehicleFilter = document.createElement('div');
                vehicleFilter.id = 'vehicle-filter';
                vehicleFilter.innerHTML = `
                    <div style="background: rgba(15, 23, 42, 0.95); border: 1px solid #334155; border-radius: 12px; padding: 15px; margin: 10px 0; backdrop-filter: blur(10px);">
                        <h4 style="color: #f8fafc; margin: 0 0 10px 0; font-size: 14px; font-weight: 600;">üöó Select Vehicle Type</h4>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            <button onclick="window.UniHubTracking.filterByVehicle('all')" style="background: #64748b; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">All</button>
                            <button onclick="window.UniHubTracking.filterByVehicle('taxi')" style="background: #fbbf24; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">üöï Taxi</button>
                            <button onclick="window.UniHubTracking.filterByVehicle('shuttle')" style="background: #3b82f6; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">üöå Shuttle</button>
                            <button onclick="window.UniHubTracking.filterByVehicle('pragia')" style="background: #10b981; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; cursor: pointer;">üèçÔ∏è Pragia</button>
                        </div>
                        <div id="vehicle-stats" style="margin-top: 10px; font-size: 12px; color: #94a3b8;"></div>
                    </div>
                `;
                
                // Insert before map container
                const mapContainer = document.getElementById('map');
                if (mapContainer) {
                    mapContainer.parentNode.insertBefore(vehicleFilter, mapContainer);
                }
                
                // Create location permission modal
                const permissionModal = document.createElement('div');
                permissionModal.id = 'permission-modal';
                permissionModal.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.8);
                    display: none;
                    align-items: center;
                    justify-content: center;
                    z-index: 10002;
                `;
                permissionModal.innerHTML = `
                    <div style="background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 20px; max-width: 400px; margin: 20px;">
                        <h3 style="color: #f8fafc; margin: 0 0 15px 0;">üìç Location Access</h3>
                        <p style="color: #cbd5e1; margin: 0 0 20px 0; font-size: 14px;">UniHub needs your location to show nearby drivers and provide accurate pickup services.</p>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="grantLocationPermission()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; flex: 1;">Allow Location</button>
                            <button onclick="denyLocationPermission()" style="background: #ef4444; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; flex: 1;">Deny</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(permissionModal);
                
                // Create driver navigation panel
                const driverPanel = document.createElement('div');
                driverPanel.id = 'driver-panel';
                driverPanel.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(15, 23, 42, 0.95);
                    border: 1px solid #334155;
                    border-radius: 12px;
                    padding: 20px;
                    backdrop-filter: blur(10px);
                    display: none;
                    z-index: 10003;
                    max-width: 400px;
                    width: 90%;
                `;
                driverPanel.innerHTML = `
                    <h3 style="color: #f8fafc; margin: 0 0 15px 0;">üó∫Ô∏è Driver Navigation</h3>
                    <div id="navigation-content" style="color: #cbd5e1; font-size: 14px;"></div>
                    <button onclick="closeDriverPanel()" style="background: #64748b; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 15px;">Close</button>
                `;
                document.body.appendChild(driverPanel);
            }
            
            // Request location permission
            async function requestLocationPermission() {
                try {
                    if (navigator.permissions) {
                        const permission = await navigator.permissions.query({ name: 'geolocation' });
                        locationPermission = permission.state;
                        
                        if (permission.state === 'granted') {
                            startPassengerTracking();
                        } else if (permission.state === 'prompt') {
                            showPermissionModal();
                        } else {
                            showManualLocationOption();
                        }
                        
                        permission.addEventListener('change', () => {
                            locationPermission = permission.state;
                            if (permission.state === 'granted') {
                                startPassengerTracking();
                            }
                        });
                    } else {
                        showPermissionModal();
                    }
                } catch (error) {
                    console.error('‚ùå Permission check failed:', error);
                    showPermissionModal();
                }
            }
            
            // Show permission modal
            function showPermissionModal() {
                const modal = document.getElementById('permission-modal');
                if (modal) {
                    modal.style.display = 'flex';
                }
            }
            
            // Hide permission modal
            function hidePermissionModal() {
                const modal = document.getElementById('permission-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
            
            // Grant location permission
            function grantLocationPermission() {
                hidePermissionModal();
                startPassengerTracking();
                showNotification('üìç Location access granted - Tracking started');
            }
            
            // Deny location permission
            function denyLocationPermission() {
                hidePermissionModal();
                showManualLocationOption();
            }
            
            // Show manual location option
            function showManualLocationOption() {
                showNotification('‚ö†Ô∏è Location denied - Using default location');
                updatePassengerLocation(config.mapCenter[0], config.mapCenter[1]);
                updateVehicleStats();
            }
            
            // Toggle mobile map
            function toggleMobileMap() {
                const mapContainer = document.getElementById('map');
                const toggle = document.getElementById('mobile-map-toggle');
                
                if (!mapContainer || !toggle) {
                    console.error('‚ùå Map container or toggle not found');
                    return;
                }
                
                mapVisible = !mapVisible;
                
                console.log('üó∫Ô∏è Toggling map:', mapVisible ? 'show' : 'hide');
                
                if (mapVisible) {
                    mapContainer.style.display = 'block';
                    toggle.innerHTML = 'üó∫Ô∏è Hide Map';
                    if (map) {
                        setTimeout(() => {
                            map.invalidateSize();
                        }, 100);
                    }
                } else {
                    mapContainer.style.display = 'none';
                    toggle.innerHTML = 'üó∫Ô∏è Show Map';
                }
            }
            
            // Filter by vehicle type
            function filterByVehicle(vehicleType) {
                currentVehicleFilter = vehicleType;
                updateDriverDisplay();
                updateVehicleStats();
            }
            
            // Update vehicle statistics
            function updateVehicleStats() {
                const statsElement = document.getElementById('vehicle-stats');
                if (!statsElement) return;
                
                const stats = {
                    all: Object.keys(drivers).length,
                    taxi: 0,
                    shuttle: 0,
                    pragia: 0
                };
                
                Object.values(drivers).forEach(driver => {
                    if (driver.vehicleType && stats[driver.vehicleType] !== undefined) {
                        stats[driver.vehicleType]++;
                    }
                });
                
                let html = '';
                if (currentVehicleFilter === 'all') {
                    html = `üöó ${stats.all} drivers available`;
                } else {
                    const vehicle = config.vehicleTypes[currentVehicleFilter];
                    html = `${vehicle.icon} ${stats[currentVehicleFilter]} ${vehicle.name}s available - ${vehicle.waitTime} wait`;
                }
                
                statsElement.innerHTML = html;
            }
            
            // Update driver display based on filter
            function updateDriverDisplay() {
                Object.keys(drivers).forEach(driverId => {
                    const driver = drivers[driverId];
                    const shouldShow = currentVehicleFilter === 'all' || driver.vehicleType === currentVehicleFilter;
                    
                    if (shouldShow) {
                        if (!driver._onMap) {
                            driver.addTo(map);
                            driver._onMap = true;
                        }
                    } else {
                        if (driver._onMap) {
                            map.removeLayer(driver);
                            driver._onMap = false;
                        }
                    }
                });
            }
            
            // Get realistic location and center map
            async function getRealisticLocationAndCenterMap() {
                console.log('üîç Getting your realistic location...');
                
                try {
                    const location = await getRealisticLocation();
                    console.log(`üìç Your location: ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)} (${location.method})`);
                    
                    // Center map on user's actual location
                    map.setView([location.lat, location.lng], 16);
                    
                    // Update passenger position
                    updatePassengerLocationWithGeoreference(location.lat, location.lng, location.accuracy);
                    
                    // Show location indicator
                    showLocationIndicator(location);
                    
                    // Start continuous tracking
                    startRealisticTracking(location);
                    
                } catch (error) {
                    console.error('‚ùå Could not get location:', error);
                    showNotification('üìç Using default location - Please enable location access');
                }
            }
            
            // Get realistic location with multiple methods
            async function getRealisticLocation() {
                // Method 1: Try browser GPS first
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(
                            resolve,
                            reject,
                            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                        );
                    });
                    
                    return {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        method: 'GPS'
                    };
                } catch (error) {
                    console.warn('‚ö†Ô∏è GPS failed, trying alternatives...');
                }
                
                // Method 2: Try network location
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(
                            resolve,
                            reject,
                            { enableHighAccuracy: false, timeout: 8000, maximumAge: 30000 }
                        );
                    });
                    
                    return {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        method: 'Network'
                    };
                } catch (error) {
                    console.warn('‚ö†Ô∏è Network location failed, trying IP location...');
                }
                
                // Method 3: IP-based location
                try {
                    const response = await fetch('https://ipapi.co/json/');
                    const data = await response.json();
                    
                    return {
                        lat: data.latitude,
                        lng: data.longitude,
                        accuracy: 10000,
                        city: data.city,
                        country: data.country_name,
                        method: 'IP Location'
                    };
                } catch (error) {
                    console.warn('‚ö†Ô∏è IP location failed, using manual selection...');
                }
                
                // Method 4: Manual location selection
                return await getManualLocation();
            }
            
            // Manual location selection with realistic options
            async function getManualLocation() {
                return new Promise((resolve) => {
                    // Create location selection modal
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(0,0,0,0.8);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 10000;
                    `;
                    
                    modal.innerHTML = `
                        <div style="background: white; padding: 30px; border-radius: 12px; max-width: 450px; width: 90%; max-height: 80vh; overflow-y: auto;">
                            <h3 style="margin: 0 0 20px 0; text-align: center;">üìç Select Your Location</h3>
                            <p style="margin: 0 0 20px 0; color: #64748b; text-align: center;">
                                We couldn't detect your location automatically. Please select where you are:
                            </p>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin: 0 0 10px 0; font-size: 16px;">üè´ Campus Locations</h4>
                                <div style="display: grid; gap: 10px;">
                                    <button onclick="selectLocation(5.6037, -0.18696, 'Main Gate, KNUST')" style="padding: 12px; border: 1px solid #d1d5db; background: #f8fafc; border-radius: 6px; cursor: pointer; text-align: left;">
                                        <div style="font-weight: 600;">üö™ Main Gate</div>
                                        <div style="font-size: 12px; color: #64748b;">KNUST Main Entrance</div>
                                    </button>
                                    <button onclick="selectLocation(5.6050, -0.1870, 'Library, KNUST')" style="padding: 12px; border: 1px solid #d1d5db; background: #f8fafc; border-radius: 6px; cursor: pointer; text-align: left;">
                                        <div style="font-weight: 600;">üìö Library</div>
                                        <div style="font-size: 12px; color: #64748b;">Main Library Building</div>
                                    </button>
                                    <button onclick="selectLocation(5.6060, -0.1880, 'Science Block, KNUST')" style="padding: 12px; border: 1px solid #d1d5db; background: #f8fafc; border-radius: 6px; cursor: pointer; text-align: left;">
                                        <div style="font-weight: 600;">üî¨ Science Block</div>
                                        <div style="font-size: 12px; color: #64748b;">Science Faculty</div>
                                    </button>
                                    <button onclick="selectLocation(5.6040, -0.1850, 'Student Center, KNUST')" style="padding: 12px; border: 1px solid #d1d5db; background: #f8fafc; border-radius: 6px; cursor: pointer; text-align: left;">
                                        <div style="font-weight: 600;">üë• Student Center</div>
                                        <div style="font-size: 12px; color: #64748b;">Student Activities Center</div>
                                    </button>
                                    <button onclick="selectLocation(5.6020, -0.1840, 'Hostel A, KNUST')" style="padding: 12px; border: 1px solid #d1d5db; background: #f8fafc; border-radius: 6px; cursor: pointer; text-align: left;">
                                        <div style="font-weight: 600;">üè† Hostel A</div>
                                        <div style="font-size: 12px; color: #64748b;">Student Hostel</div>
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin: 0 0 10px 0; font-size: 16px;">üèôÔ∏è Kumasi Areas</h4>
                                <div style="display: grid; gap: 10px;">
                                    <button onclick="selectLocation(5.6148, -0.2059, 'Adum, Kumasi')" style="padding: 12px; border: 1px solid #d1d5db; background: #fef3c7; border-radius: 6px; cursor: pointer; text-align: left;">
                                        <div style="font-weight: 600;">üè™ Adum</div>
                                        <div style="font-size: 12px; color: #64748b;">Central Kumasi</div>
                                    </button>
                                    <button onclick="selectLocation(5.6415, -0.1863, 'Kejetia, Kumasi')" style="padding: 12px; border: 1px solid #d1d5db; background: #fef3c7; border-radius: 6px; cursor: pointer; text-align: left;">
                                        <div style="font-weight: 600;">üöå Kejetia</div>
                                        <div style="font-size: 12px; color: #64748b;">Main Bus Terminal</div>
                                    </button>
                                    <button onclick="selectLocation(5.5950, -0.1969, 'Asokwa, Kumasi')" style="padding: 12px; border: 1px solid #d1d5db; background: #fef3c7; border-radius: 6px; cursor: pointer; text-align: left;">
                                        <div style="font-weight: 600;">üè≠ Asokwa</div>
                                        <div style="font-size: 12px; color: #64748b;">Industrial Area</div>
                                    </button>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <h4 style="margin: 0 0 10px 0; font-size: 16px;">üåç Other Options</h4>
                                <button onclick="selectLocation(5.6037, -0.18696, 'KNUST Campus')" style="padding: 12px; border: 1px solid #d1d5db; background: #dbeafe; border-radius: 6px; cursor: pointer; text-align: left; width: 100%;">
                                    <div style="font-weight: 600;">üéì KNUST Campus (Default)</div>
                                    <div style="font-size: 12px; color: #64748b;">Main campus area</div>
                                </button>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button onclick="this.closest('.location-modal').remove()" style="flex: 1; padding: 12px; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer;">
                                    Cancel
                                </button>
                            </div>
                        </div>
                    `;
                    
                    modal.className = 'location-modal';
                    document.body.appendChild(modal);
                    
                    // Handle location selection
                    window.selectLocation = function(lat, lng, name) {
                        modal.remove();
                        resolve({
                            lat: parseFloat(lat),
                            lng: parseFloat(lng),
                            accuracy: 100,
                            method: 'Manual',
                            locationName: name
                        });
                    };
                });
            }
            
            // Show location indicator
            function showLocationIndicator(location) {
                const indicator = document.createElement('div');
                indicator.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    background: white;
                    padding: 12px 16px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    font-size: 14px;
                    z-index: 1000;
                    max-width: 250px;
                `;
                
                const methodIcons = {
                    'GPS': 'üõ∞Ô∏è',
                    'Network': 'üì∂',
                    'IP Location': 'üåê',
                    'Manual': 'üìç'
                };
                
                const accuracyText = location.accuracy ? ` (¬±${Math.round(location.accuracy)}m)` : '';
                const locationName = location.locationName || location.city || '';
                
                indicator.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 4px;">
                        ${methodIcons[location.method] || 'üìç'} ${location.method}
                    </div>
                    ${locationName ? `<div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">${locationName}</div>` : ''}
                    <div style="font-size: 12px; color: #94a3b8;">
                        ${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}${accuracyText}
                    </div>
                `;
                
                document.body.appendChild(indicator);
                
                // Auto-hide after 8 seconds
                setTimeout(() => {
                    if (indicator.parentNode) {
                        indicator.parentNode.removeChild(indicator);
                    }
                }, 8000);
            }
            
            // Start realistic continuous tracking
            function startRealisticTracking(initialLocation) {
                if (!navigator.geolocation) {
                    console.warn('‚ö†Ô∏è Geolocation not supported');
                    return;
                }
                
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 30000
                };
                
                const watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        const location = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        
                        // Only update if position changed significantly (more than 10 meters)
                        const distance = calculateDistance(
                            initialLocation.lat, initialLocation.lng,
                            location.lat, location.lng
                        );
                        
                        if (distance > 0.01) { // 10 meters
                            updatePassengerLocationWithGeoreference(location.lat, location.lng, location.accuracy);
                            initialLocation = location;
                        }
                    },
                    (error) => {
                        console.warn('‚ö†Ô∏è Tracking error:', error.message);
                    },
                    options
                );
                
                // Store watch ID for cleanup
                window.locationWatchId = watchId;
            }
            
            // Initialize Leaflet map
            function initMap() {
                try {
                    const mapContainer = document.getElementById('map');
                    if (!mapContainer) {
                        console.error('‚ùå Map container not found');
                        return;
                    }
                    
                    // Set map container size with proper layout
                    mapContainer.style.height = isMobile ? '50vh' : 'calc(100vh - 120px)';
                    mapContainer.style.maxHeight = '600px';
                    mapContainer.style.width = '100%';
                    mapContainer.style.border = '1px solid #334155';
                    mapContainer.style.borderRadius = '8px';
                    mapContainer.style.background = '#e2e8f0';
                    mapContainer.style.position = 'relative';
                    mapContainer.style.zIndex = '1'; // Lower z-index to prevent covering menu
                    mapContainer.style.marginTop = '60px'; // Space for header
                    mapContainer.style.overflow = 'hidden';
                    
                    // Show map by default on desktop, hide on mobile
                    if (isMobile && !mapVisible) {
                        mapContainer.style.display = 'none';
                    } else {
                        mapContainer.style.display = 'block';
                    }
                    
                    // Create map instance with error handling
                    try {
                        map = L.map('map', {
                            center: config.mapCenter,
                            zoom: config.defaultZoom,
                            zoomControl: true,
                            attributionControl: true,
                            worldCopyJump: true
                        });
                        
                        console.log('‚úÖ Map instance created');
                    } catch (mapError) {
                        console.error('‚ùå Map creation failed:', mapError);
                        showNotification('‚ùå Map initialization failed');
                        return;
                    }
                    
                    // Add OpenStreetMap tiles with error handling
                    try {
                        const tileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '¬© OpenStreetMap contributors',
                            maxZoom: config.maxZoom,
                            errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==',
                            tileSize: 256,
                            detectRetina: true
                        });
                        
                        tileLayer.on('tileerror', function(e) {
                            console.warn('‚ö†Ô∏è Tile loading error:', e);
                        });
                        
                        tileLayer.on('tileload', function(e) {
                            console.log('‚úÖ Tile loaded:', e.tile.src);
                        });
                        
                        tileLayer.addTo(map);
                        console.log('‚úÖ Tile layer added successfully');
                        
                    } catch (tileError) {
                        console.error('‚ùå Tile layer failed:', tileError);
                        showNotification('‚ùå Map tiles failed to load');
                        return;
                    }
                    
                    // Enable map interactions
                    map.on('click', function(e) {
                        console.log('üó∫Ô∏è Map clicked at:', e.latlng);
                        showNotification(`üó∫Ô∏è Map clicked: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}`);
                    });
                    
                    // Get user's realistic location and center map
                    getRealisticLocationAndCenterMap();
                    
                    map.on('zoomend', function() {
                        console.log('üîç Map zoom level:', map.getZoom());
                    });
                    
                    map.on('load', function() {
                        console.log('‚úÖ Map fully loaded');
                        showNotification('üó∫Ô∏è Map loaded successfully');
                    });
                    
                    console.log('üó∫Ô∏è Map initialized successfully');
                    
                } catch (error) {
                    console.error('‚ùå Failed to initialize map:', error);
                    showNotification('‚ùå Map initialization failed - Please refresh');
                }
            }
            
            // Start passenger location tracking
            function startPassengerTracking() {
                if (!navigator.geolocation) {
                    console.warn('‚ö†Ô∏è Geolocation not supported');
                    updatePassengerLocation(config.mapCenter[0], config.mapCenter[1]);
                    return;
                }
                
                try {
                    watchId = navigator.geolocation.watchPosition(
                        function(position) {
                            updatePassengerLocation(position.coords.latitude, position.coords.longitude);
                        },
                        function(error) {
                            console.error('üìç Geolocation error:', error);
                            updatePassengerLocation(config.mapCenter[0], config.mapCenter[1]);
                        },
                        config.geolocationOptions
                    );
                    
                    console.log('üìç Passenger tracking started');
                } catch (error) {
                    console.error('‚ùå Failed to start passenger tracking:', error);
                    updatePassengerLocation(config.mapCenter[0], config.mapCenter[1]);
                }
            }
            
            // Update passenger location
            function updatePassengerLocation(lat, lng) {
                passengerPosition = { lat, lng };
                
                try {
                    // Remove existing passenger marker
                    if (passengerMarker) {
                        map.removeLayer(passengerMarker);
                    }
                    
                    // Create passenger icon
                    const passengerIcon = L.divIcon({
                        html: '<div style="background: #10b981; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12],
                        popupAnchor: [0, -12]
                    });
                    
                    // Add passenger marker
                    passengerMarker = L.marker([lat, lng], { icon: passengerIcon })
                        .addTo(map)
                        .bindPopup('üìç Your Location');
                    
                    // Center map on passenger if no drivers
                    if (Object.keys(drivers).length === 0) {
                        map.setView([lat, lng], config.defaultZoom);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Failed to update passenger location:', error);
                }
            }
            
            // Start driver simulation with vehicle types
            function startDriverSimulation() {
                console.log('üöó Starting enhanced driver simulation...');
                
                const vehicleTypeKeys = Object.keys(config.vehicleTypes);
                const initialDrivers = [
                    { id: 'driver1', lat: 5.6037, lng: -0.18696, speed: 0.0001, direction: Math.random() * 360, vehicleType: 'taxi' },
                    { id: 'driver2', lat: 5.6050, lng: -0.1850, speed: 0.00015, direction: Math.random() * 360, vehicleType: 'shuttle' },
                    { id: 'driver3', lat: 5.6020, lng: -0.1880, speed: 0.00012, direction: Math.random() * 360, vehicleType: 'pragia' },
                    { id: 'driver4', lat: 5.6045, lng: -0.1875, speed: 0.00008, direction: Math.random() * 360, vehicleType: 'taxi' },
                    { id: 'driver5', lat: 5.6030, lng: -0.1845, speed: 0.00011, direction: Math.random() * 360, vehicleType: 'shuttle' },
                    { id: 'driver6', lat: 5.6060, lng: -0.1890, speed: 0.00009, direction: Math.random() * 360, vehicleType: 'pragia' },
                    { id: 'driver7', lat: 5.6015, lng: -0.1860, speed: 0.00013, direction: Math.random() * 360, vehicleType: 'taxi' },
                    { id: 'driver8', lat: 5.6040, lng: -0.1830, speed: 0.00010, direction: Math.random() * 360, vehicleType: 'shuttle' }
                ];
                
                // Add initial drivers
                initialDrivers.forEach(driver => {
                    updateDriverLocation(driver);
                });
                
                // Update vehicle stats
                updateVehicleStats();
                
                // Simulate real-time movement
                simulationInterval = setInterval(() => {
                    Object.keys(drivers).forEach(driverId => {
                        const marker = drivers[driverId];
                        const currentPos = marker.getLatLng();
                        
                        const driver = initialDrivers.find(d => d.id === driverId);
                        if (driver) {
                            // Update direction occasionally
                            if (Math.random() < 0.1) {
                                driver.direction += (Math.random() - 0.5) * 45;
                            }
                            
                            // Calculate new position
                            const deltaLat = Math.sin(driver.direction * Math.PI / 180) * driver.speed;
                            const deltaLng = Math.cos(driver.direction * Math.PI / 180) * driver.speed;
                            
                            const newLat = currentPos.lat + deltaLat;
                            const newLng = currentPos.lng + deltaLng;
                            
                            // Update driver location
                            driver.lat = newLat;
                            driver.lng = newLng;
                            
                            updateDriverLocation(driver);
                        }
                    });
                    
                    // Occasionally simulate ride assignment
                    if (Math.random() < 0.05) {
                        const driverIds = Object.keys(drivers);
                        if (driverIds.length > 0 && passengerPosition) {
                            const randomDriver = driverIds[Math.floor(Math.random() * driverIds.length)];
                            simulateRideAssignment(randomDriver);
                        }
                    }
                    
                }, config.updateInterval);
                
                console.log('‚úÖ Enhanced driver simulation started');
            }
            
            // Update driver location with vehicle type and georeferencing
            function updateDriverLocation(data) {
                try {
                    const { id, lat, lng, vehicleType } = data;
                    
                    if (!id || typeof lat !== 'number' || typeof lng !== 'number') {
                        console.warn('‚ö†Ô∏è Invalid driver location data:', data);
                        return;
                    }
                    
                    // Georeference driver location
                    const georeferencedLocation = georeferenceLocation(lat, lng, 'driver');
                    if (!georeferencedLocation) {
                        console.error('‚ùå Failed to georeference driver location');
                        return;
                    }
                    
                    // Remove existing driver marker
                    if (drivers[id]) {
                        map.removeLayer(drivers[id]);
                    }
                    
                    // Get vehicle type info
                    const vehicle = config.vehicleTypes[vehicleType] || config.vehicleTypes.taxi;
                    
                    // Create driver icon with vehicle type and status indicator
                    const driverIcon = L.divIcon({
                        html: `<div style="background: ${vehicle.color}; width: 32px; height: 32px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; font-size: 16px; position: relative;">
                            ${vehicle.icon}
                            <div style="position: absolute; top: -2px; right: -2px; background: #10b981; width: 8px; height: 8px; border-radius: 50%; border: 1px solid white;"></div>
                        </div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16],
                        popupAnchor: [0, -16]
                    });
                    
                    // Calculate distance to passenger
                    const distanceToPassenger = passengerPosition ? 
                        calculateDistance(lat, lng, passengerPosition.lat, passengerPosition.lng) : 
                        null;
                    
                    const eta = distanceToPassenger ? 
                        calculateETA(distanceToPassenger, vehicleType) : 
                        null;
                    
                    // Add driver marker with enhanced popup
                    const marker = L.marker([lat, lng], { icon: driverIcon })
                        .bindPopup(`
                            <div style="text-align: center; min-width: 200px;">
                                <div style="font-size: 18px; margin-bottom: 8px;">${vehicle.icon} ${vehicle.name}</div>
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">Driver ${id}</div>
                                <div style="font-size: 12px; color: #10b981; margin-bottom: 4px;">${vehicle.baseFare.toFixed(2)} GHS base fare</div>
                                <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">Capacity: ${vehicle.capacity} passengers</div>
                                ${distanceToPassenger ? `
                                    <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; padding: 8px; margin: 8px 0;">
                                        <div style="font-size: 11px; color: #3b82f6; margin-bottom: 2px;">üìç ${distanceToPassenger.toFixed(1)} km away</div>
                                        <div style="font-size: 11px; color: #3b82f6;">‚è±Ô∏è ${eta ? eta.formatted : 'Calculating...'}</div>
                                    </div>
                                ` : ''}
                                <div style="font-size: 10px; color: #94a3b8; margin-bottom: 8px;">üìç ${georeferencedLocation.address || 'Location updating...'}</div>
                                <button onclick="window.UniHubTracking.requestRide('${id}')" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; margin-top: 5px; cursor: pointer; width: 100%; font-weight: 600;">Request Ride</button>
                            </div>
                        `);
                    
                    // Store driver marker with enhanced metadata
                    marker.vehicleType = vehicleType;
                    marker._onMap = true;
                    marker.georeferencedLocation = georeferencedLocation;
                    marker.lastUpdate = Date.now();
                    marker.distanceToPassenger = distanceToPassenger;
                    marker.eta = eta;
                    drivers[id] = marker;
                    
                    // Apply filter if needed
                    if (currentVehicleFilter !== 'all' && vehicleType !== currentVehicleFilter) {
                        map.removeLayer(marker);
                        marker._onMap = false;
                    }
                    
                    // Update routes if this driver is on active mission
                    if (activeMission && activeMission.driverId === id) {
                        updateDriverRoute(id, passengerPosition);
                    }
                    
                    console.log(`üöó ${vehicle.name} ${id} updated: ${lat.toFixed(6)}, ${lng.toFixed(6)} (üìç ${georeferencedLocation.address || 'Unknown'})`);
                    
                } catch (error) {
                    console.error('‚ùå Failed to update driver location:', error);
                }
            }
            
            // Request ride from specific driver with route tracing
            async function requestRide(driverId) {
                const driver = drivers[driverId];
                if (!driver) return;
                
                const driverPos = driver.getLatLng();
                const vehicle = config.vehicleTypes[driver.vehicleType];
                
                console.log('üéØ Ride requested:', driverId, vehicle.name);
                
                // Clear any existing routes
                clearRoutes();
                
                // Create active mission
                activeMission = {
                    driverId: driverId,
                    passengerLocation: passengerPosition,
                    driverLocation: { lat: driverPos.lat, lng: driverPos.lng },
                    status: 'requested',
                    requestTime: Date.now(),
                    vehicleType: driver.vehicleType
                };
                
                showNotification(`üöó ${vehicle.name} requested! Driver ${driverId} is on the way.`);
                
                // Start driver navigation with route tracing
                await startDriverNavigationWithRoute(driverId, driverPos.lat, driverPos.lng);
                
                // Start passenger route tracing
                await updatePassengerRoute(driverId);
                
                // Focus map to show both routes
                if (map && driverPos && passengerPosition) {
                    const bounds = L.latLngBounds([
                        [driverPos.lat, driverPos.lng],
                        [passengerPosition.lat, passengerPosition.lng]
                    ]);
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }
            
            // Enhanced driver navigation with route tracing
            async function startDriverNavigationWithRoute(driverId, pickupLat, pickupLng) {
                if (!passengerPosition) {
                    console.warn('‚ö†Ô∏è No passenger position available');
                    return;
                }
                
                activeMission.status = 'dispatched';
                activeMission.pickupLocation = { lat: pickupLat, lng: pickupLng };
                
                // Get and draw driver route
                await updateDriverRoute(driverId, passengerPosition);
                
                // Show enhanced driver navigation panel
                showDriverPanel(`
                    <div style="text-align: center;">
                        <h4 style="color: #10b981; margin: 0 0 15px 0;">üöó Mission Active</h4>
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="font-size: 14px; margin-bottom: 5px;"><strong>Driver ${driverId}</strong></div>
                            <div style="font-size: 12px; color: #94a3b8;">Status: <span style="color: #10b981;">En Route</span></div>
                            <div style="font-size: 12px; color: #94a3b8;">Vehicle: ${config.vehicleTypes[drivers[driverId].vehicleType].icon} ${config.vehicleTypes[drivers[driverId].vehicleType].name}</div>
                        </div>
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="font-size: 14px; margin-bottom: 8px;"><strong>üõ£Ô∏è Route Information</strong></div>
                            <div style="font-size: 12px; color: #94a3b8;" id="driver-route-info">Calculating route...</div>
                        </div>
                        <div style="font-size: 12px; color: #cbd5e1; margin-bottom: 15px;">
                            <div>üìç Follow red route to passenger</div>
                            <div>üìû Contact passenger when nearby</div>
                            <div>‚úÖ Confirm pickup on arrival</div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button onclick="window.UniHubTracking.completeMission('${driverId}')" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; flex: 1;">Complete Pickup</button>
                            <button onclick="window.UniHubTracking.openGoogleMaps('${driverId}')" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; flex: 1;">üó∫Ô∏è Maps</button>
                        </div>
                    </div>
                `);
                
                // Open Google Maps for driver navigation
                const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${pickupLat},${pickupLng}&destination=${passengerPosition.lat},${passengerPosition.lng}&travelmode=driving`;
                console.log(`üó∫Ô∏è Driver navigation: ${mapsUrl}`);
            }
            
            // Update existing passenger location tracking to use enhanced version
            function startPassengerTracking() {
                if (!navigator.geolocation) {
                    console.warn('‚ö†Ô∏è Geolocation not supported');
                    updatePassengerLocationWithGeoreference(config.mapCenter[0], config.mapCenter[1], null);
                    return;
                }
                
                try {
                    watchId = navigator.geolocation.watchPosition(
                        function(position) {
                            updatePassengerLocationWithGeoreference(
                                position.coords.latitude, 
                                position.coords.longitude, 
                                position.coords.accuracy
                            );
                        },
                        function(error) {
                            console.error('üìç Geolocation error:', error);
                            updatePassengerLocationWithGeoreference(config.mapCenter[0], config.mapCenter[1], null);
                        },
                        config.geolocationOptions
                    );
                    
                    console.log('üìç Enhanced passenger tracking started');
                } catch (error) {
                    console.error('‚ùå Failed to start passenger tracking:', error);
                    updatePassengerLocationWithGeoreference(config.mapCenter[0], config.mapCenter[1], null);
                }
            }
            
            // Start driver navigation
            function startDriverNavigation(driverId, pickupLat, pickupLng) {
                activeMission = {
                    driverId: driverId,
                    pickup: [pickupLat, pickupLng],
                    status: 'dispatched',
                    startTime: Date.now()
                };
                
                // Show driver navigation panel
                showDriverPanel(`
                    <div style="text-align: center;">
                        <h4 style="color: #10b981; margin: 0 0 15px 0;">üöó Mission Active</h4>
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="font-size: 14px; margin-bottom: 5px;"><strong>Driver ${driverId}</strong></div>
                            <div style="font-size: 12px; color: #94a3b8;">Status: <span style="color: #10b981;">Dispatched</span></div>
                            <div style="font-size: 12px; color: #94a3b8;">Pickup: ${pickupLat.toFixed(4)}, ${pickupLng.toFixed(4)}</div>
                        </div>
                        <div style="font-size: 12px; color: #cbd5e1; margin-bottom: 15px;">
                            <div>üìç Navigate to pickup location</div>
                            <div>‚è±Ô∏è Estimated arrival: 5-8 minutes</div>
                            <div>üìû Contact passenger when nearby</div>
                        </div>
                        <button onclick="window.UniHubTracking.completeMission('${driverId}')" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%;">Complete Pickup</button>
                    </div>
                `);
                
                // Open Google Maps for driver navigation
                if (passengerPosition) {
                    const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${pickupLat},${pickupLng}&destination=${passengerPosition.lat},${passengerPosition.lng}&travelmode=driving`;
                    window.open(mapsUrl, '_blank');
                }
            }
            
            // Show driver panel
            function showDriverPanel(content) {
                const panel = document.getElementById('driver-panel');
                const contentDiv = document.getElementById('navigation-content');
                if (panel && contentDiv) {
                    contentDiv.innerHTML = content;
                    panel.style.display = 'block';
                }
            }
            
            // Close driver panel
            function closeDriverPanel() {
                const panel = document.getElementById('driver-panel');
                if (panel) {
                    panel.style.display = 'none';
                }
            }
            
            // Complete mission
            function completeMission(driverId) {
                if (activeMission && activeMission.driverId === driverId) {
                    activeMission.status = 'completed';
                    showNotification(`‚úÖ Pickup completed for Driver ${driverId}`);
                    closeDriverPanel();
                    
                    // Reset for next mission
                    setTimeout(() => {
                        activeMission = null;
                    }, 2000);
                }
            }
            
            // Simulate ride assignment
            function simulateRideAssignment(driverId) {
                try {
                    const driver = drivers[driverId];
                    if (!driver || !passengerPosition) return;
                    
                    const driverPos = driver.getLatLng();
                    const vehicle = config.vehicleTypes[driver.vehicleType];
                    
                    console.log('üéØ Ride assigned:', driverId, vehicle.name);
                    
                    showNotification(`üöó ${vehicle.name} assigned! Opening navigation...`);
                    
                    // Start driver navigation
                    startDriverNavigation(driverId, driverPos.lat, driverPos.lng);
                    
                } catch (error) {
                    console.error('‚ùå Failed to simulate ride assignment:', error);
                }
            }
            
            // Navigate driver using Google Maps
            function navigateDriver(destinationLat, destinationLng) {
                try {
                    if (!destinationLat || !destinationLng) {
                        console.warn('‚ö†Ô∏è Invalid destination coordinates');
                        return;
                    }
                    
                    let originLat, originLng;
                    
                    if (passengerPosition) {
                        originLat = passengerPosition.lat;
                        originLng = passengerPosition.lng;
                    } else {
                        [originLat, originLng] = config.mapCenter;
                    }
                    
                    const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${originLat},${originLng}&destination=${destinationLat},${destinationLng}&travelmode=driving`;
                    
                    window.open(mapsUrl, '_blank');
                    
                    console.log(`üó∫Ô∏è Navigation opened: ${originLat},${originLng} ‚Üí ${destinationLat},${destinationLng}`);
                    
                } catch (error) {
                    console.error('‚ùå Failed to open navigation:', error);
                }
            }
            
            // Show notification
            function showNotification(message) {
                try {
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #10b981;
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 10000;
                        font-family: system-ui, -apple-system, sans-serif;
                        font-size: 14px;
                        animation: slideIn 0.3s ease;
                        max-width: 300px;
                    `;
                    notification.textContent = message;
                    
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 5000);
                    
                } catch (error) {
                    console.error('‚ùå Failed to show notification:', error);
                }
            }
            
            // ===== GEOREFERENCING & ROUTING SYSTEM =====
            
            // Georeference location with proper validation
            function georeferenceLocation(lat, lng, type = 'passenger') {
                const location = {
                    lat: parseFloat(lat),
                    lng: parseFloat(lng),
                    type: type,
                    timestamp: Date.now(),
                    accuracy: null,
                    address: null
                };
                
                // Validate coordinates
                if (Math.abs(location.lat) > 90 || Math.abs(location.lng) > 180) {
                    console.error('‚ùå Invalid coordinates:', lat, lng);
                    return null;
                }
                
                // Add geocoding for better location context
                geocodeLocation(location);
                
                return location;
            }
            
            // Geocode location to get address
            async function geocodeLocation(location) {
                const cacheKey = `${location.lat.toFixed(4)},${location.lng.toFixed(4)}`;
                
                if (geocodedLocations.has(cacheKey)) {
                    location.address = geocodedLocations.get(cacheKey);
                    return location.address;
                }
                
                try {
                    // Using Nominatim (OpenStreetMap) for geocoding
                    const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${location.lat}&lon=${location.lng}&zoom=18&addressdetails=1`);
                    const data = await response.json();
                    
                    if (data && data.display_name) {
                        location.address = data.display_name;
                        geocodedLocations.set(cacheKey, data.display_name);
                        console.log(`üìç Geocoded ${location.type}:`, data.display_name);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Geocoding failed:', error);
                    location.address = 'Unknown location';
                }
                
                return location.address;
            }
            
            // Calculate distance between two points (Haversine formula)
            function calculateDistance(lat1, lng1, lat2, lng2) {
                const R = 6371; // Earth's radius in kilometers
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLng = (lng2 - lng1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c; // Distance in kilometers
            }
            
            // Calculate estimated time of arrival (ETA)
            function calculateETA(distance, vehicleType = 'taxi') {
                const speeds = {
                    taxi: 40,    // km/h average city speed
                    shuttle: 35,  // km/h (slower due to stops)
                    pragia: 45    // km/h (motorcycle, faster)
                };
                
                const speed = speeds[vehicleType] || speeds.taxi;
                const timeHours = distance / speed;
                const timeMinutes = Math.round(timeHours * 60);
                
                return {
                    minutes: timeMinutes,
                    formatted: `${timeMinutes} min`,
                    distance: distance.toFixed(1)
                };
            }
            
            // Get route using OSRM (Open Source Routing Machine)
            async function getRoute(startLat, startLng, endLat, endLng, profile = 'driving') {
                try {
                    const url = `https://router.project-osrm.org/route/v1/${profile}/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson&steps=true`;
                    
                    console.log(`üõ£Ô∏è Getting route: ${startLat},${startLng} ‚Üí ${endLat},${endLng}`);
                    
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data && data.routes && data.routes.length > 0) {
                        const route = data.routes[0];
                        return {
                            geometry: route.geometry,
                            distance: route.distance / 1000, // Convert to km
                            duration: route.duration / 60,    // Convert to minutes
                            steps: route.legs[0].steps,
                            coordinates: route.geometry.coordinates.map(coord => [coord[1], coord[0]]) // Flip lat/lng
                        };
                    }
                } catch (error) {
                    console.error('‚ùå Route calculation failed:', error);
                    return null;
                }
                
                return null;
            }
            
            // Draw route on map
            function drawRoute(routeData, style = {}) {
                if (!map || !routeData || !routeData.coordinates) {
                    console.warn('‚ö†Ô∏è Cannot draw route - missing data');
                    return null;
                }
                
                // Remove existing route
                if (activeRoute) {
                    map.removeLayer(activeRoute);
                }
                
                const defaultStyle = {
                    color: '#3b82f6',
                    weight: 4,
                    opacity: 0.7,
                    dashArray: null
                };
                
                const routeStyle = { ...defaultStyle, ...style };
                
                // Create route polyline
                const route = L.polyline(routeData.coordinates, routeStyle).addTo(map);
                
                // Add route information
                const distance = routeData.distance.toFixed(1);
                const duration = Math.round(routeData.duration);
                
                route.bindPopup(`
                    <div style="text-align: center; font-size: 12px;">
                        <strong>Route Information</strong><br>
                        üìè Distance: ${distance} km<br>
                        ‚è±Ô∏è Duration: ${duration} min<br>
                        üöó Profile: ${config.routing.profile}
                    </div>
                `);
                
                activeRoute = route;
                
                // Fit map to show route
                if (routeData.coordinates.length > 0) {
                    map.fitBounds(route.getBounds(), { padding: [50, 50] });
                }
                
                console.log(`‚úÖ Route drawn: ${distance} km, ${duration} min`);
                
                return route;
            }
            
            // Update driver route to passenger
            async function updateDriverRoute(driverId, passengerPos) {
                const driver = drivers[driverId];
                if (!driver || !passengerPos) {
                    console.warn('‚ö†Ô∏è Cannot update route - missing driver or passenger');
                    return;
                }
                
                const driverPos = driver.getLatLng();
                
                // Get route from driver to passenger
                const routeData = await getRoute(
                    driverPos.lat, driverPos.lng,
                    passengerPos.lat, passengerPos.lng,
                    'driving'
                );
                
                if (routeData) {
                    // Draw driver route with specific style
                    const routeStyle = {
                        color: '#ef4444', // Red for driver route
                        weight: 4,
                        opacity: 0.8,
                        dashArray: '10, 5'
                    };
                    
                    driverRoute = drawRoute(routeData, routeStyle);
                    
                    // Update driver navigation panel with route info
                    const eta = calculateETA(routeData.distance, driver.vehicleType);
                    updateDriverNavigationPanel(driverId, eta, routeData);
                    
                    console.log(`üöó Driver ${driverId} route updated: ${routeData.distance.toFixed(1)} km, ${Math.round(routeData.duration)} min`);
                }
            }
            
            // Update passenger route to driver
            async function updatePassengerRoute(driverId) {
                const driver = drivers[driverId];
                if (!driver || !passengerPosition) {
                    console.warn('‚ö†Ô∏è Cannot update passenger route - missing driver or passenger');
                    return;
                }
                
                const driverPos = driver.getLatLng();
                
                // Get route from passenger to driver
                const routeData = await getRoute(
                    passengerPosition.lat, passengerPosition.lng,
                    driverPos.lat, driverPos.lng,
                    'walking' // Passenger walks to pickup
                );
                
                if (routeData) {
                    // Draw passenger route with specific style
                    const routeStyle = {
                        color: '#10b981', // Green for passenger route
                        weight: 3,
                        opacity: 0.6,
                        dashArray: '5, 5'
                    };
                    
                    passengerRoute = drawRoute(routeData, routeStyle);
                    
                    // Update passenger info
                    const eta = calculateETA(routeData.distance, 'walking');
                    updatePassengerRouteInfo(driverId, eta, routeData);
                    
                    console.log(`üìç Passenger route updated: ${routeData.distance.toFixed(1)} km, ${Math.round(routeData.duration)} min`);
                }
            }
            
            // Update driver navigation panel with route information
            function updateDriverNavigationPanel(driverId, eta, routeData) {
                const panel = document.getElementById('navigation-content');
                if (!panel) return;
                
                const vehicle = config.vehicleTypes[drivers[driverId].vehicleType];
                
                panel.innerHTML = `
                    <div style="text-align: center;">
                        <h4 style="color: #10b981; margin: 0 0 15px 0;">üöó Mission Active</h4>
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="font-size: 14px; margin-bottom: 5px;"><strong>Driver ${driverId}</strong></div>
                            <div style="font-size: 12px; color: #94a3b8;">Status: <span style="color: #10b981;">En Route</span></div>
                            <div style="font-size: 12px; color: #94a3b8;">Vehicle: ${vehicle.icon} ${vehicle.name}</div>
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div style="font-size: 14px; margin-bottom: 8px;"><strong>üìç Route Information</strong></div>
                            <div style="font-size: 12px; color: #94a3b8;">üìè Distance: ${routeData.distance.toFixed(1)} km</div>
                            <div style="font-size: 12px; color: #94a3b8;">‚è±Ô∏è ETA: ${eta.formatted}</div>
                            <div style="font-size: 12px; color: #94a3b8;">üöó Speed: ${vehicle.name} profile</div>
                        </div>
                        <div style="font-size: 12px; color: #cbd5e1; margin-bottom: 15px;">
                            <div>üìç Navigate to pickup location</div>
                            <div>üìû Contact passenger when nearby</div>
                            <div>‚úÖ Confirm pickup on arrival</div>
                        </div>
                        <button onclick="window.UniHubTracking.completeMission('${driverId}')" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; width: 100%;">Complete Pickup</button>
                    </div>
                `;
            }
            
            // Update passenger route information
            function updatePassengerRouteInfo(driverId, eta, routeData) {
                const vehicle = config.vehicleTypes[drivers[driverId].vehicleType];
                
                // Update passenger marker popup with route info
                if (passengerMarker) {
                    passengerMarker.setPopupContent(`
                        <div style="text-align: center;">
                            <div style="font-size: 16px; margin-bottom: 8px;">üìç Your Location</div>
                            <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 6px; padding: 10px; margin-bottom: 8px;">
                                <div style="font-size: 12px; color: #10b981; margin-bottom: 4px;"><strong>Driver ${driverId} is coming</strong></div>
                                <div style="font-size: 11px; color: #64748b;">${vehicle.icon} ${vehicle.name}</div>
                                <div style="font-size: 11px; color: #64748b;">üìè ${routeData.distance.toFixed(1)} km away</div>
                                <div style="font-size: 11px; color: #64748b;">‚è±Ô∏è ${eta.formatted} walk time</div>
                            </div>
                            <div style="font-size: 10px; color: #94a3b8;">Click driver marker for details</div>
                        </div>
                    `);
                }
                
                // Show notification to passenger
                showNotification(`üöó ${vehicle.name} ${driverId} is ${routeData.distance.toFixed(1)} km away - ${eta.formatted} walk`);
            }
            
            // Clear all routes
            function clearRoutes() {
                if (activeRoute) {
                    map.removeLayer(activeRoute);
                    activeRoute = null;
                }
                if (driverRoute) {
                    map.removeLayer(driverRoute);
                    driverRoute = null;
                }
                if (passengerRoute) {
                    map.removeLayer(passengerRoute);
                    passengerRoute = null;
                }
            }
            
            // Enhanced passenger location update with georeferencing
            function updatePassengerLocationWithGeoreference(lat, lng, accuracy = null) {
                const georeferencedLocation = georeferenceLocation(lat, lng, 'passenger');
                if (!georeferencedLocation) {
                    console.error('‚ùå Failed to georeference passenger location');
                    return;
                }
                
                georeferencedLocation.accuracy = accuracy;
                passengerPosition = georeferencedLocation;
                
                try {
                    // Remove existing passenger marker
                    if (passengerMarker) {
                        map.removeLayer(passengerMarker);
                    }
                    
                    // Create passenger icon with accuracy indicator
                    const accuracyRadius = accuracy ? L.circle([lat, lng], {
                        radius: accuracy,
                        color: '#10b981',
                        fillColor: '#10b981',
                        fillOpacity: 0.1,
                        weight: 1
                    }) : null;
                    
                    const passengerIcon = L.divIcon({
                        html: '<div style="background: #10b981; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); position: relative;"><div style="position: absolute; top: -8px; right: -8px; background: #ef4444; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div></div>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12],
                        popupAnchor: [0, -12]
                    });
                    
                    // Add passenger marker
                    passengerMarker = L.marker([lat, lng], { icon: passengerIcon })
                        .addTo(map)
                        .bindPopup('üìç Your Location');
                    
                    // Add accuracy circle if available
                    if (accuracyRadius) {
                        accuracyRadius.addTo(map);
                    }
                    
                    // Center map on passenger if no drivers
                    if (Object.keys(drivers).length === 0) {
                        map.setView([lat, lng], config.defaultZoom);
                    }
                    
                    // Update routes if active mission exists
                    if (activeMission) {
                        updateDriverRoute(activeMission.driverId, passengerPosition);
                        updatePassengerRoute(activeMission.driverId);
                    }
                    
                    console.log(`‚úÖ Passenger location updated: ${lat.toFixed(6)}, ${lng.toFixed(6)} (¬±${accuracy || 'unknown'}m)`);
                    
                } catch (error) {
                    console.error('‚ùå Failed to update passenger location:', error);
                }
            }
            
            // Public API
            window.UniHubTracking = {
                init: initTracking,
                navigateDriver: navigateDriver,
                getDriverCount: () => Object.keys(drivers).length,
                getPassengerPosition: () => passengerPosition,
                centerMapOnPassenger: () => {
                    if (passengerPosition && map) {
                        map.setView([passengerPosition.lat, passengerPosition.lng], config.defaultZoom);
                    }
                },
                addDriver: (id, lat, lng, vehicleType = 'taxi') => {
                    updateDriverLocation({ id, lat: parseFloat(lat), lng: parseFloat(lng), vehicleType });
                    updateVehicleStats();
                },
                removeDriver: (id) => {
                    if (drivers[id]) {
                        map.removeLayer(drivers[id]);
                        delete drivers[id];
                        updateVehicleStats();
                    }
                },
                simulateRide: (driverId) => {
                    simulateRideAssignment(driverId);
                },
                requestRide: requestRide,
                filterByVehicle: filterByVehicle,
                toggleMobileMap: toggleMobileMap,
                completeMission: completeMission,
                getActiveMission: () => activeMission,
                getLocationPermission: () => locationPermission,
                
                // New georeferencing and routing API
                georeferenceLocation: georeferenceLocation,
                calculateDistance: calculateDistance,
                calculateETA: calculateETA,
                getRoute: getRoute,
                drawRoute: drawRoute,
                clearRoutes: clearRoutes,
                updateDriverRoute: updateDriverRoute,
                updatePassengerRoute: updatePassengerRoute,
                openGoogleMaps: (driverId) => {
                    const driver = drivers[driverId];
                    if (driver && passengerPosition) {
                        const driverPos = driver.getLatLng();
                        const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${driverPos.lat},${driverPos.lng}&destination=${passengerPosition.lat},${passengerPosition.lng}&travelmode=driving`;
                        window.open(mapsUrl, '_blank');
                    }
                },
                getGeocodedAddress: (lat, lng) => {
                    const cacheKey = `${parseFloat(lat).toFixed(4)},${parseFloat(lng).toFixed(4)}`;
                    return geocodedLocations.get(cacheKey) || null;
                }
            };
            
            // Global functions for button onclick handlers
            window.filterByVehicle = filterByVehicle;
            window.grantLocationPermission = grantLocationPermission;
            window.denyLocationPermission = denyLocationPermission;
            window.closeDriverPanel = closeDriverPanel;
            
            // Auto-initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initTracking);
            } else {
                initTracking();
            }
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                
                @media (max-width: 768px) {
                    #map {
                        transition: all 0.3s ease;
                    }
                    
                    #mobile-map-toggle:hover {
                        transform: scale(1.05);
                        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
                    }
                }
            `;
            document.head.appendChild(style);
            
        })();
    </script>
</body>
</html>
