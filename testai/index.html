
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NexRyde | Next-Gen Logistics</title>
    
    <!-- PWA & Mobile Optimization -->
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" href="/NexRyde.png">
     <link rel="icon" href="/NexRyde192.png">
     <link rel="icon" href="/NexRyde152.png">
    <meta name="theme-color" content="#f59e0b">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://api.dicebear.com/7.x/shapes/svg?seed=nexryde&backgroundColor=f59e0b">

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7812709042449387" crossorigin="anonymous"></script>
    <!-- AMP Auto Ads (for AMP pages; non-AMP sites use the script above) -->
    <script async custom-element="amp-auto-ads" src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- UniHub Live Tracking Module - Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin="" />
    
    <!-- UniHub Live Tracking Module - Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    
    <!-- UniHub Live Tracking Module - Socket.IO JS -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #f8fafc;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }
        .glass {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .glass-bright {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #020617;
        }
        ::-webkit-scrollbar-thumb {
            background: #1e293b;
            border-radius: 10px;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Scanner UI Tweaks */
        #qr-reader {
          border: none !important;
          border-radius: 2rem;
          overflow: hidden;
        }
        #qr-reader__scan_region {
          background: #020617 !important;
        }
        #qr-reader__dashboard {
          padding: 20px !important;
        }
        #qr-reader__dashboard_section_csr button {
          background-color: #4f46e5 !important;
          color: white !important;
          border-radius: 0.75rem !important;
          padding: 8px 16px !important;
          font-weight: 800 !important;
          text-transform: uppercase !important;
          font-size: 10px !important;
        }

        @keyframes scan {
          0% { top: 0; }
          100% { top: 100%; }
        }
        .scanner-line {
          height: 2px;
          background: #10b981;
          position: absolute;
          width: 100%;
          animation: scan 2s linear infinite;
          box-shadow: 0 0 15px #10b981;
          z-index: 20;
          left: 0;
        }
        
        /* UniHub Live Tracking Module - Map Styles */
        #map {
          height: 400px;
          width: 100%;
          border: 1px solid #334155;
          border-radius: 8px;
          margin: 20px 0;
          background: #0f172a;
          position: relative;
          z-index: 100;
          display: block;
        }
        
        @media (max-width: 768px) {
          #map {
            height: 300px;
            margin: 10px 0;
          }
        }
        
        /* Ensure map is not hidden behind React app */
        #root {
          position: relative;
          z-index: 1;
        }
        
        body {
          position: relative;
        }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "@google/genai": "https://esm.sh/@google/genai@^1.38.0",
    "react/": "https://esm.sh/react@^19.2.4/",
    "vite": "https://esm.sh/vite@^7.3.1",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2",
    "@supabase/supabase-js": "https://esm.sh/@supabase/supabase-js@^2.93.3"
  }
}
</script>
<!-- Inline styles only; no index.css to avoid 404/MIME issues when missing -->
</head>
<body>
    <div id="root"></div>
    
    <!-- UniHub Live Tracking Module - Map Container -->
    <div id="map"></div>
    
    <script type="module" src="./index.tsx"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => {
                    console.warn('SW registration failed:', err);
                });
            });
        }
    </script>
    
    <!-- UniHub Live Tracking Module - Inline Script (avoids MIME issues) -->
    <script>
        // Inline tracking module to avoid MIME type issues
        (function() {
            'use strict';
            
            // Global variables
            let map = null;
            let drivers = {};
            let passengerMarker = null;
            let passengerPosition = null;
            let simulationInterval = null;
            let watchId = null;
            
            // Configuration
            const config = {
                mapCenter: [5.6037, -0.18696], // Kumasi, Ghana
                defaultZoom: 13,
                maxZoom: 19,
                updateInterval: 2000, // 2 seconds
                geolocationOptions: {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            };
            
            // Initialize the tracking system
            function initTracking() {
                console.log('üöÄ Initializing UniHub Live Tracking (Inline)...');
                
                // Wait for Leaflet to be available
                if (typeof L === 'undefined') {
                    setTimeout(initTracking, 500);
                    return;
                }
                
                // Initialize map
                initMap();
                
                // Start passenger location tracking
                startPassengerTracking();
                
                // Start driver simulation
                startDriverSimulation();
                
                console.log('‚úÖ Live Tracking initialized successfully');
            }
            
            // Initialize Leaflet map
            function initMap() {
                try {
                    // Check if map container exists
                    const mapContainer = document.getElementById('map');
                    if (!mapContainer) {
                        console.error('‚ùå Map container not found');
                        return;
                    }
                    
                    // Set map container size
                    mapContainer.style.height = '400px';
                    mapContainer.style.width = '100%';
                    mapContainer.style.border = '1px solid #334155';
                    mapContainer.style.borderRadius = '8px';
                    mapContainer.style.background = '#0f172a';
                    mapContainer.style.position = 'relative';
                    mapContainer.style.zIndex = '100';
                    
                    // Create map instance
                    map = L.map('map', {
                        center: config.mapCenter,
                        zoom: config.defaultZoom,
                        zoomControl: true,
                        attributionControl: true
                    });
                    
                    // Add OpenStreetMap tiles
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: config.maxZoom
                    }).addTo(map);
                    
                    // Enable map interactions
                    map.on('click', function(e) {
                        console.log('üó∫Ô∏è Map clicked at:', e.latlng);
                    });
                    
                    console.log('üó∫Ô∏è Map initialized successfully');
                    
                } catch (error) {
                    console.error('‚ùå Failed to initialize map:', error);
                }
            }
            
            // Start passenger location tracking
            function startPassengerTracking() {
                if (!navigator.geolocation) {
                    console.warn('‚ö†Ô∏è Geolocation not supported');
                    updatePassengerLocation(config.mapCenter[0], config.mapCenter[1]);
                    return;
                }
                
                try {
                    watchId = navigator.geolocation.watchPosition(
                        function(position) {
                            updatePassengerLocation(position.coords.latitude, position.coords.longitude);
                        },
                        function(error) {
                            console.error('üìç Geolocation error:', error);
                            updatePassengerLocation(config.mapCenter[0], config.mapCenter[1]);
                        },
                        config.geolocationOptions
                    );
                    
                    console.log('üìç Passenger tracking started');
                } catch (error) {
                    console.error('‚ùå Failed to start passenger tracking:', error);
                    updatePassengerLocation(config.mapCenter[0], config.mapCenter[1]);
                }
            }
            
            // Update passenger location
            function updatePassengerLocation(lat, lng) {
                passengerPosition = { lat, lng };
                
                try {
                    // Remove existing passenger marker
                    if (passengerMarker) {
                        map.removeLayer(passengerMarker);
                    }
                    
                    // Create passenger icon
                    const passengerIcon = L.divIcon({
                        html: '<div style="background: #10b981; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12],
                        popupAnchor: [0, -12]
                    });
                    
                    // Add passenger marker
                    passengerMarker = L.marker([lat, lng], { icon: passengerIcon })
                        .addTo(map)
                        .bindPopup('üìç Your Location');
                    
                    // Center map on passenger if no drivers
                    if (Object.keys(drivers).length === 0) {
                        map.setView([lat, lng], config.defaultZoom);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Failed to update passenger location:', error);
                }
            }
            
            // Start driver simulation
            function startDriverSimulation() {
                console.log('üöó Starting driver simulation...');
                
                const initialDrivers = [
                    { id: 'driver1', lat: 5.6037, lng: -0.18696, speed: 0.0001, direction: Math.random() * 360 },
                    { id: 'driver2', lat: 5.6050, lng: -0.1850, speed: 0.00015, direction: Math.random() * 360 },
                    { id: 'driver3', lat: 5.6020, lng: -0.1880, speed: 0.00012, direction: Math.random() * 360 },
                    { id: 'driver4', lat: 5.6045, lng: -0.1875, speed: 0.00008, direction: Math.random() * 360 },
                    { id: 'driver5', lat: 5.6030, lng: -0.1845, speed: 0.00011, direction: Math.random() * 360 }
                ];
                
                // Add initial drivers
                initialDrivers.forEach(driver => {
                    updateDriverLocation(driver);
                });
                
                // Simulate real-time movement
                simulationInterval = setInterval(() => {
                    Object.keys(drivers).forEach(driverId => {
                        const marker = drivers[driverId];
                        const currentPos = marker.getLatLng();
                        
                        const driver = initialDrivers.find(d => d.id === driverId);
                        if (driver) {
                            if (Math.random() < 0.1) {
                                driver.direction += (Math.random() - 0.5) * 45;
                            }
                            
                            const deltaLat = Math.sin(driver.direction * Math.PI / 180) * driver.speed;
                            const deltaLng = Math.cos(driver.direction * Math.PI / 180) * driver.speed;
                            
                            const newLat = currentPos.lat + deltaLat;
                            const newLng = currentPos.lng + deltaLng;
                            
                            driver.lat = newLat;
                            driver.lng = newLng;
                            
                            updateDriverLocation(driver);
                        }
                    });
                    
                    // Occasionally simulate ride assignment
                    if (Math.random() < 0.05) {
                        const driverIds = Object.keys(drivers);
                        if (driverIds.length > 0 && passengerPosition) {
                            const randomDriver = driverIds[Math.floor(Math.random() * driverIds.length)];
                            simulateRideAssignment(randomDriver);
                        }
                    }
                    
                }, config.updateInterval);
                
                console.log('‚úÖ Driver simulation started');
            }
            
            // Update driver location
            function updateDriverLocation(data) {
                try {
                    const { id, lat, lng } = data;
                    
                    if (!id || typeof lat !== 'number' || typeof lng !== 'number') {
                        console.warn('‚ö†Ô∏è Invalid driver location data:', data);
                        return;
                    }
                    
                    if (drivers[id]) {
                        map.removeLayer(drivers[id]);
                    }
                    
                    const driverIcon = L.divIcon({
                        html: '<div style="background: #3b82f6; width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12],
                        popupAnchor: [0, -12]
                    });
                    
                    const marker = L.marker([lat, lng], { icon: driverIcon })
                        .addTo(map)
                        .bindPopup(`üöó Driver ${id}`);
                    
                    drivers[id] = marker;
                    
                    console.log(`üöó Driver ${id} updated: ${lat.toFixed(6)}, ${lng.toFixed(6)}`);
                    
                } catch (error) {
                    console.error('‚ùå Failed to update driver location:', error);
                }
            }
            
            // Simulate ride assignment
            function simulateRideAssignment(driverId) {
                try {
                    const driver = drivers[driverId];
                    if (!driver || !passengerPosition) return;
                    
                    const driverPos = driver.getLatLng();
                    
                    console.log('üéØ Ride assigned:', driverId);
                    
                    showNotification('üöó Driver assigned! Opening navigation...');
                    
                    navigateDriver(driverPos.lat, driverPos.lng);
                    
                    if (map && driverPos) {
                        map.setView([driverPos.lat, driverPos.lng], 15);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Failed to simulate ride assignment:', error);
                }
            }
            
            // Navigate driver using Google Maps
            function navigateDriver(destinationLat, destinationLng) {
                try {
                    if (!destinationLat || !destinationLng) {
                        console.warn('‚ö†Ô∏è Invalid destination coordinates');
                        return;
                    }
                    
                    let originLat, originLng;
                    
                    if (passengerPosition) {
                        originLat = passengerPosition.lat;
                        originLng = passengerPosition.lng;
                    } else {
                        [originLat, originLng] = config.mapCenter;
                    }
                    
                    const mapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${originLat},${originLng}&destination=${destinationLat},${destinationLng}&travelmode=driving`;
                    
                    window.open(mapsUrl, '_blank');
                    
                    console.log(`üó∫Ô∏è Navigation opened: ${originLat},${originLng} ‚Üí ${destinationLat},${destinationLng}`);
                    
                } catch (error) {
                    console.error('‚ùå Failed to open navigation:', error);
                }
            }
            
            // Show notification
            function showNotification(message) {
                try {
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #10b981;
                        color: white;
                        padding: 12px 20px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 10000;
                        font-family: system-ui, -apple-system, sans-serif;
                        font-size: 14px;
                        animation: slideIn 0.3s ease;
                    `;
                    notification.textContent = message;
                    
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 5000);
                    
                } catch (error) {
                    console.error('‚ùå Failed to show notification:', error);
                }
            }
            
            // Public API
            window.UniHubTracking = {
                init: initTracking,
                navigateDriver: navigateDriver,
                getDriverCount: () => Object.keys(drivers).length,
                getPassengerPosition: () => passengerPosition,
                centerMapOnPassenger: () => {
                    if (passengerPosition && map) {
                        map.setView([passengerPosition.lat, passengerPosition.lng], config.defaultZoom);
                    }
                },
                addDriver: (id, lat, lng) => {
                    updateDriverLocation({ id, lat: parseFloat(lat), lng: parseFloat(lng) });
                },
                removeDriver: (id) => {
                    if (drivers[id]) {
                        map.removeLayer(drivers[id]);
                        delete drivers[id];
                    }
                },
                simulateRide: (driverId) => {
                    simulateRideAssignment(driverId);
                }
            };
            
            // Auto-initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initTracking);
            } else {
                initTracking();
            }
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
        })();
    </script>
</body>
</html>
